  name: Java CI with MongoDB

  on:
    push:
      branches: [ main, master ]  # Add your dev branch
    pull_request:
      branches: [ main, master ]
    workflow_dispatch:

  jobs:
    build-and-test:
      runs-on: ubuntu-latest

      services:
        mongo:
          image: mongo:8.0
          env:
            MONGO_INITDB_ROOT_USERNAME: admin
            MONGO_INITDB_ROOT_PASSWORD: admin
            MONGO_INITDB_DATABASE: dp
          ports:
            - 27017:27017
          options: >-
            --health-cmd "mongosh --quiet --eval 'db.runCommand({ ping: 1 })'"
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5

      env:
        MAVEN_OPTS: -Xmx2g

      steps:
        - name: Checkout dp-service
          uses: actions/checkout@v4
          with:
            path: dp-service

        - name: Checkout dp-grpc dependency
          uses: actions/checkout@v4
          with:
            repository: craigmcchesney/dp-grpc
            path: dp-grpc
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: Set up JDK 21
          uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: 21
            cache: 'maven'

#        - name: Wait for MongoDB
#          run: |
#            echo "Waiting for MongoDB to be ready..."
#            timeout 60 bash -c 'until mongosh --quiet --host localhost --port 27017 -u admin -p admin --authenticationDatabase admin --eval "db.adminCommand('\''ping'\'')" &>/dev/null; do sleep 2; done'
#            echo "MongoDB is ready!"

        - name: Run all tests (unit + integration)
          run: |
            cd dp-service
            mvn --batch-mode clean verify

        - name: Upload test reports
          uses: actions/upload-artifact@v4
          if: always()  # Upload even if tests fail
          with:
            name: test-reports
            path: |
              dp-service/target/surefire-reports/**/*
              dp-service/target/failsafe-reports/**/*
          continue-on-error: true  # Don't fail the workflow if no reports found
